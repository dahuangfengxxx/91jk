<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¿ä¸Šè°ƒè¯• - éšæ¯å±…</title>
    <link rel="stylesheet" href="assets/css/styles.css?v=4">
    <link rel="stylesheet" href="assets/css/enhancements.css?v=10">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="light-theme">
    <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
        <h2>ğŸ” çº¿ä¸Šè°ƒè¯•å·¥å…·</h2>
        
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <h3>æ•°æ®åŠ è½½çŠ¶æ€</h3>
            <div id="status" style="font-family: monospace;">æ­£åœ¨æ£€æµ‹...</div>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <h3>èƒ¡èåœç›¸å…³é…æ–¹æµ‹è¯•</h3>
            <div id="carrot-test" style="font-family: monospace;">ç­‰å¾…æµ‹è¯•...</div>
        </div>
        
        <button onclick="runTest()" style="background: #22c55e; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">
            ğŸ§ª è¿è¡Œæµ‹è¯•
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
        let testDataManager = null;
        
        // ç®€åŒ–çš„æ•°æ®ç®¡ç†å™¨
        class SimpleTestDataManager {
            constructor() {
                this.ingredients = [];
                this.recipes = [];
                this.recipeIngredients = [];
                this.isLoaded = false;
            }
            
            async initialize() {
                try {
                    document.getElementById('status').innerHTML = 'ğŸ“¡ æ­£åœ¨åŠ è½½æ•°æ®...';
                    
                    // åŠ è½½é£Ÿææ•°æ®
                    const ingredientsRes = await fetch('ingredients_master.csv');
                    const ingredientsText = await ingredientsRes.text();
                    
                    Papa.parse(ingredientsText, {
                        header: true,
                        complete: (results) => {
                            this.ingredients = results.data.filter(row => row.name_zh);
                            this.updateStatus(`âœ… é£Ÿæ: ${this.ingredients.length} æ¡`);
                        }
                    });
                    
                    // åŠ è½½é…æ–¹æ•°æ®
                    const recipesRes = await fetch('recipes_master.csv');
                    const recipesText = await recipesRes.text();
                    
                    Papa.parse(recipesText, {
                        header: true,
                        complete: (results) => {
                            this.recipes = results.data.filter(row => row.title_zh);
                            this.updateStatus(`âœ… é…æ–¹: ${this.recipes.length} æ¡`);
                        }
                    });
                    
                    // åŠ è½½é…æ–¹é£Ÿæå…³ç³»
                    const recipeIngredientsRes = await fetch('recipe_ingredients_restructured.csv');
                    const recipeIngredientsText = await recipeIngredientsRes.text();
                    
                    Papa.parse(recipeIngredientsText, {
                        header: true,
                        complete: (results) => {
                            this.recipeIngredients = results.data.filter(row => row['èœè°±åç§°']);
                            this.updateStatus(`âœ… é…æ–¹é£Ÿæå…³ç³»: ${this.recipeIngredients.length} æ¡`);
                            this.isLoaded = true;
                        }
                    });
                    
                } catch (error) {
                    this.updateStatus(`âŒ åŠ è½½å¤±è´¥: ${error.message}`);
                }
            }
            
            updateStatus(message) {
                const statusEl = document.getElementById('status');
                statusEl.innerHTML += '<br>' + message;
            }
            
            getIngredientRecipes(ingredientName) {
                if (!this.isLoaded) {
                    return [];
                }
                
                const relatedRecipeNames = [];
                
                this.recipeIngredients.forEach(recipeRecord => {
                    const recipeName = recipeRecord['èœè°±åç§°'];
                    if (!recipeName) return;
                    
                    // æ£€æŸ¥æ‰€æœ‰é…æ–™å­—æ®µ
                    for (let i = 1; i <= 10; i++) {
                        const ingredientField = `é…æ–™${i}_åç§°`;
                        const ingredient = recipeRecord[ingredientField];
                        
                        if (ingredient && ingredient.includes(ingredientName)) {
                            if (!relatedRecipeNames.includes(recipeName)) {
                                relatedRecipeNames.push(recipeName);
                            }
                            break;
                        }
                    }
                });
                
                return this.recipes.filter(recipe => 
                    relatedRecipeNames.includes(recipe.title_zh)
                );
            }
        }
        
        async function runTest() {
            if (!testDataManager) {
                testDataManager = new SimpleTestDataManager();
                await testDataManager.initialize();
                
                // ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ
                setTimeout(() => {
                    testCarrotRecipes();
                }, 2000);
            } else {
                testCarrotRecipes();
            }
        }
        
        function testCarrotRecipes() {
            const testEl = document.getElementById('carrot-test');
            
            if (!testDataManager.isLoaded) {
                testEl.innerHTML = 'âš ï¸ æ•°æ®å°šæœªå®Œå…¨åŠ è½½';
                return;
            }
            
            const carrotRecipes = testDataManager.getIngredientRecipes('èƒ¡èåœ');
            
            testEl.innerHTML = `
                <div>ğŸ¥• æµ‹è¯•é£Ÿæ: èƒ¡èåœ</div>
                <div>ğŸ“‹ æ‰¾åˆ°é…æ–¹æ•°é‡: ${carrotRecipes.length}</div>
                ${carrotRecipes.map((recipe, index) => 
                    `<div>ğŸ“ ${index + 1}. ${recipe.title_zh}</div>`
                ).join('')}
                <br>
                <div>ğŸ“Š è°ƒè¯•ä¿¡æ¯:</div>
                <div>- é…æ–¹é£Ÿæè®°å½•æ€»æ•°: ${testDataManager.recipeIngredients.length}</div>
                <div>- é£Ÿææ€»æ•°: ${testDataManager.ingredients.length}</div>
                <div>- é…æ–¹æ€»æ•°: ${testDataManager.recipes.length}</div>
            `;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œ
        window.onload = () => {
            runTest();
        };
    </script>
</body>
</html>